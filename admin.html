<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…å®¹ç®¡ç† - é¦’å¤´éŸ³ä¹å°ç«™</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: calc(70px + var(--spacing-xl)) var(--spacing-md) var(--spacing-2xl);
        }
        
        .admin-header {
            margin-bottom: var(--spacing-2xl);
        }
        
        .admin-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .admin-tabs {
            display: flex;
            gap: var(--spacing-md);
            border-bottom: 2px solid var(--border-light);
            margin-bottom: var(--spacing-xl);
        }
        
        .admin-tab {
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .admin-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .admin-tab:hover {
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .admin-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: var(--transition);
        }
        
        .admin-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .admin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-md);
        }
        
        .admin-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }
        
        .admin-card-meta {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: var(--spacing-md);
        }
        
        .admin-card-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .btn-edit {
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-edit:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn-delete {
            padding: var(--spacing-xs) var(--spacing-md);
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-delete:hover {
            background: #fee;
            color: #c33;
            border-color: #c33;
        }
        
        .btn-add {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* ç¼–è¾‘è¡¨å•æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
        }
        
        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--border-light);
        }
        
        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }
        
        .modal-close:hover {
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            font-size: 0.9375rem;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: var(--font-sans);
            transition: var(--transition);
            background: var(--surface);
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(201, 115, 79, 0.1);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
        }
        
        .rating-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
        }
        
        .rating-input-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--border-light);
        }
        
        .btn-cancel {
            padding: var(--spacing-md) var(--spacing-xl);
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-cancel:hover {
            background: var(--background);
        }
        
        .btn-save {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-save:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-icon">ğŸµ</span>
                <a href="index.html" class="logo-text" style="text-decoration: none; color: inherit;">é¦’å¤´éŸ³ä¹å°ç«™</a>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html" class="nav-link">è¿”å›ä¸»é¡µ</a></li>
            </ul>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1 class="admin-title">å†…å®¹ç®¡ç†</h1>
            <p style="color: var(--text-secondary);">ç¼–è¾‘æ–°é²œé€Ÿé€’ã€ç»å…¸é‡æ¸©ã€æ¦œä¸Šæœ‰åç­‰å†…å®¹</p>
        </div>

        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="fresh">æ–°é²œé€Ÿé€’</button>
            <button class="admin-tab" data-tab="classic">ç»å…¸é‡æ¸©</button>
            <button class="admin-tab" data-tab="topics">æ¦œä¸Šæœ‰å</button>
        </div>

        <!-- æ–°é²œé€Ÿé€’ -->
        <div class="tab-content active" id="tab-fresh">
            <button class="btn-add" onclick="openAddModal('fresh')">+ æ·»åŠ æ–°æ–‡ç« </button>
            <div class="admin-grid" id="fresh-list">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- ç»å…¸é‡æ¸© -->
        <div class="tab-content" id="tab-classic">
            <button class="btn-add" onclick="openAddModal('classic')">+ æ·»åŠ æ–°æ–‡ç« </button>
            <div class="admin-grid" id="classic-list">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- æ¦œä¸Šæœ‰å -->
        <div class="tab-content" id="tab-topics">
            <button class="btn-add" onclick="openAddModal('topics')">+ æ·»åŠ æ–°ä¸“é¢˜</button>
            <div class="admin-grid" id="topics-list">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">ç¼–è¾‘å†…å®¹</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId" name="id">
                <input type="hidden" id="editType" name="type">

                <div class="form-group">
                    <label class="form-label">æ ‡é¢˜</label>
                    <input type="text" class="form-input" id="editTitle" name="title" required>
                </div>

                <div class="form-group">
                    <label class="form-label">è‰ºæœ¯å®¶/ä½œè€…</label>
                    <input type="text" class="form-input" id="editArtist" name="artist" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å‘è¡Œæ—¥æœŸ/å¹´ä»½</label>
                        <input type="text" class="form-input" id="editDate" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç±»å‹</label>
                        <input type="text" class="form-input" id="editGenre" name="genre" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">æ ‡ç­¾</label>
                    <input type="text" class="form-input" id="editTag" name="tag" placeholder="å¦‚ï¼šæ–°ä¸“è¾‘ã€å•æ›²ã€EP">
                </div>

                <div class="form-group">
                    <label class="form-label">å¼€ç¯‡ç»¼è¿°ï¼ˆçº¢è‰²å—ï¼‰</label>
                    <textarea class="form-textarea" id="editIntro" name="intro" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">ä¹è¯„æ­£æ–‡</label>
                    <textarea class="form-textarea" id="editContent" name="content" style="min-height: 200px;" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">è¯„åˆ†</label>
                    <div class="rating-inputs">
                        <div class="rating-input-group">
                            <label class="form-label" style="font-size: 0.875rem;">æ€»åˆ†</label>
                            <input type="number" class="form-input" id="editTotalScore" name="totalScore" step="0.1" min="0" max="10" required>
                        </div>
                        <div class="rating-input-group">
                            <label class="form-label" style="font-size: 0.875rem;">é¦’å¤´è¯„åˆ†</label>
                            <input type="number" class="form-input" id="editScore1" name="score1" step="0.1" min="0" max="10" required>
                        </div>
                        <div class="rating-input-group">
                            <label class="form-label" style="font-size: 0.875rem;">é©¬é©¬è¯„åˆ†</label>
                            <input type="number" class="form-input" id="editScore2" name="score2" step="0.1" min="0" max="10" required>
                        </div>
                        <div class="rating-input-group">
                            <label class="form-label" style="font-size: 0.875rem;">å°é¦’å¤´è¯„åˆ†</label>
                            <input type="number" class="form-input" id="editScore3" name="score3" step="0.1" min="0" max="10" required>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="topicFields" style="display: none;">
                    <label class="form-label">ä¸“è¾‘æ•°é‡</label>
                    <input type="number" class="form-input" id="editAlbumCount" name="albumCount" min="1">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-save">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // APIåŸºç¡€åœ°å€
        // æœ¬åœ°å¼€å‘: http://localhost:3000/api
        // éƒ¨ç½²å: è‡ªåŠ¨ä½¿ç”¨å½“å‰åŸŸå
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api' 
            : '/api';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadData('fresh');
            loadData('classic');
            loadData('topics');

            // Tabåˆ‡æ¢
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                });
            });

            // è¡¨å•æäº¤
            document.getElementById('editForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveData();
            });
        });

        // ä»åç«¯åŠ è½½æ•°æ®
        async function loadData(type) {
            const container = document.getElementById(`${type}-list`);
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">åŠ è½½ä¸­...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/${type}`);
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const data = await response.json();
                
                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">æš‚æ— æ•°æ®ï¼Œç‚¹å‡»"æ·»åŠ "æŒ‰é’®åˆ›å»ºç¬¬ä¸€æ¡</p>';
                    return;
                }
                
                container.innerHTML = data.map(item => `
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div>
                                <h3 class="admin-card-title">${item.title || 'æœªå‘½å'}</h3>
                                <p class="admin-card-meta">${item.artist || item.category || ''} Â· ${item.date || ''}</p>
                            </div>
                        </div>
                        <div class="admin-card-actions">
                            <button class="btn-edit" onclick="openEditModal('${type}', ${item.id})">ç¼–è¾‘</button>
                            <button class="btn-delete" onclick="deleteItem('${type}', ${item.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                container.innerHTML = `<p style="text-align: center; color: #c33;">åŠ è½½å¤±è´¥ï¼è¯·ç¡®ä¿åç«¯æœåŠ¡å™¨å·²å¯åŠ¨ï¼ˆè¿è¡Œ node server.jsï¼‰</p>`;
            }
        }

        function openAddModal(type) {
            document.getElementById('editForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('editType').value = type;
            document.getElementById('modalTitle').textContent = `æ·»åŠ ${getTypeName(type)}`;
            document.getElementById('topicFields').style.display = type === 'topics' ? 'block' : 'none';
            document.getElementById('editModal').classList.add('active');
        }

        async function openEditModal(type, id) {
            try {
                const response = await fetch(`${API_BASE}/${type}`);
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const data = await response.json();
                const item = data.find(i => i.id === id);
                
                if (!item) {
                    alert('æœªæ‰¾åˆ°æ•°æ®');
                    return;
                }

                document.getElementById('editId').value = item.id;
                document.getElementById('editType').value = type;
                document.getElementById('editTitle').value = item.title || '';
                document.getElementById('editArtist').value = item.artist || item.category || '';
                document.getElementById('editDate').value = item.date || '';
                document.getElementById('editGenre').value = item.genre || '';
                document.getElementById('editTag').value = item.tag || '';
                document.getElementById('editIntro').value = item.intro || '';
                document.getElementById('editContent').value = item.content || '';
                document.getElementById('editTotalScore').value = item.totalScore || '';
                
                if (item.scores && Array.isArray(item.scores)) {
                    document.getElementById('editScore1').value = item.scores[0] || '';
                    document.getElementById('editScore2').value = item.scores[1] || '';
                    document.getElementById('editScore3').value = item.scores[2] || '';
                } else {
                    document.getElementById('editScore1').value = '';
                    document.getElementById('editScore2').value = '';
                    document.getElementById('editScore3').value = '';
                }
                
                if (item.albumCount) {
                    document.getElementById('editAlbumCount').value = item.albumCount;
                }
                
                document.getElementById('modalTitle').textContent = `ç¼–è¾‘${getTypeName(type)}`;
                document.getElementById('topicFields').style.display = type === 'topics' ? 'block' : 'none';
                document.getElementById('editModal').classList.add('active');
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ');
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // ä¿å­˜æ•°æ®åˆ°åç«¯
        async function saveData() {
            const formData = new FormData(document.getElementById('editForm'));
            const type = formData.get('type');
            const id = formData.get('id');
            
            // ç»„ç»‡æ•°æ®
            const data = {
                title: formData.get('title'),
                artist: formData.get('artist'),
                date: formData.get('date'),
                genre: formData.get('genre'),
                tag: formData.get('tag'),
                intro: formData.get('intro'),
                content: formData.get('content'),
                totalScore: parseFloat(formData.get('totalScore')),
                scores: [
                    parseFloat(formData.get('score1')),
                    parseFloat(formData.get('score2')),
                    parseFloat(formData.get('score3'))
                ]
            };
            
            // ä¸“é¢˜ç‰¹æœ‰å­—æ®µ
            if (type === 'topics') {
                data.category = formData.get('artist');
                data.albumCount = parseInt(formData.get('albumCount'));
            }

            try {
                let response;
                const url = `${API_BASE}/${type}`;
                
                if (id) {
                    // æ›´æ–°
                    response = await fetch(`${url}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // åˆ›å»º
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                const result = await response.json();
                
                if (result.success) {
                    alert('ä¿å­˜æˆåŠŸï¼');
                    closeModal();
                    loadData(type);
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼è¯·ç¡®ä¿åç«¯æœåŠ¡å™¨å·²å¯åŠ¨ï¼ˆè¿è¡Œ node server.jsï¼‰');
            }
        }

        // åˆ é™¤æ•°æ®
        async function deleteItem(type, id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é¡¹å†…å®¹å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/${type}/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadData(type);
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼è¯·ç¡®ä¿åç«¯æœåŠ¡å™¨å·²å¯åŠ¨');
            }
        }

        function getTypeName(type) {
            const names = {
                fresh: 'æ–°é²œé€Ÿé€’',
                classic: 'ç»å…¸é‡æ¸©',
                topics: 'æ¦œä¸Šæœ‰å'
            };
            return names[type] || '';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>

